# 使用分组函数报告聚会数据

WHERE 子句在分组之前限制数据集中的行，而 HAVING 子句在分组之后限制它们。

## 分组函数介绍

### 分组函数的定义

分组函数用来处理聚合数据，并且针对每个组返回单个结果。

`F(g1, g2, g3, ..., gn) = result1, result2, result3, ..., resultn`

分组函数对每个行集群执行一次，并且针对每个组返回一个结果。这些组可以是整个表或者是用公共值或属性关联的表的多个部分。如果表中所有的行作为分组函数的一个组，那么返回一个结果。SELECT 列表中可以出现一个或者多个分组函数。

```
SELECT group_function(column or expression), ...
FROM table [WHERE ...] [ORDER BY ...]
```

分组函数将多个行中的许多值聚合到单个结果中，它们广泛用于报告目的，也称为概要或聚合函数。

### 分组函数的类型和语法

学习分组函数时，需要记住两条基本规则。第一，它们每次总是作用于一组行。该组可能是数据集被划分的许多组的其中之一，或者可能是整个表。对每个组都执行一次分组函数。第二，忽略分组列或者表达式包含空值的行，除非提供一般函数（例如 NVL、NVL2 或者 COALESCE）来处理它们。

COUNT 函数计算组中的函数

`COUNT({*|[DISTINCT|ALL] expr})`

语法可以分解为
1. `COUNT(*)`
2. `COUNT(DISTINCT expr)`
3. `COUNT(ALL expr)`
4. `COUNT(expr)`

调用 `COUNT(*)` 时，组中的所有行（包括具有空值或者重复值的行）都计算在内。执行 `COUNT(DISTINCT expr)` 只计算每个组中 expr 唯一出现的次数。ALL 关键字是默认语法的一部分，因此 `COUNT(ALL expr)` 和 `COUNT(expr)` 是相等的表达式。它计算每个组中 expr 非空值出现的次数。expr 的数据类型可以是 NUMBER、DATE、CHAR 或者VARCHAR2。如果 expr 是空值，就会忽略它，除非使用一般函数（例如 NVL、NVL2 或者 COALESCE）来处理它。

AVG 函数计算组中表达式或者数字列的平均值

`AVG([DISTINCT|ALL] expr)`

语法可以分解为
1. `AVG(DISTINCT expr)`
2. `AVG(ALL expr)`
3. `AVG(expr)`

调用 `AVG(DISTINCT expr)` 时，将 expr 的不同值相加，并除以 expr 唯一出现的次数。`AVG(ALL expr)` 和 `AVG(expr)` 将各行中 expr 的非空值相加，用求得的和除以组中的非空行数。expr 参数的数据类型是 NUMBER。

SUM 函数返回组中非空数字表达式值的总和

`SUM([DISTINCT|ALL] expr)`

语法可以分解为
1. `SUM(DISTINCT expr)`
2. `SUM(ALL expr)`
3. `SUM(expr)`

`SUM(DISTINCT expr)` 提供组中所有唯一值相加的和，在对组中每一行计算 expr 之后返回这个值。`SUM(ALL expr)` 和 `SUM(expr)` 提供组中各行的 expr 相加的和，并且忽略空值。expr 参数的数据类型是 NUMBER。

MAX 和 MIN 函数返回组中 expr 的最大值和最小值

`MAX([DISTINCT|ALL] expr)`  
`MAX([DISTINCT|ALL] expr)`

语法可以分解为
1. `MAX(DISTINCT expr); MIN(DISTINCT expr)`
2. `MAX(ALL expr); MIN(ALL expr)`
3. `MAN(expr); MIN(expr)`

`MAN(expr)、MAX(ALL expr) 和 MAX(DISTINCT expr)` 检查一组行中 expr 的值，返回其中的最大值，并且忽略空值。`MIN(expr)、MIX(ALL expr) 和 MIX(DISTINCT expr)` 检查一组行中 expr 的值，返回其中的最小值，并且忽略空值。expr 参数的数据类型可以是 NUMBER、DATE、CHAR 或者 VARCHAR2。

STDDEV 和 VARIANCE 是 Oracle 提供的众多统计分组函数中的两个函数。

`VARIANCE([DISTINCT|ALL] expr)`  
`STDDEV([DISTINCT|ALL] expr)`

语法可以分解为
1. `VARIANCE(DISTINCT expr); STDDEV(DISTINCT expr)`
2. `VARIANCE(ALL expr); STDDEV(ALL expr)`
3. `VARIANCE(expr); STDDEV(expr)`

统计方差表示数据样本或者数据集中值的变化程度。`VARIANCE(DISTINCT expr)` 返回组中唯一非空数据的变化程度。`VARIANCE(ALL expr)` 和 `VARIANCE( expr)` 返回组中非空数据的变化程度。

STDDEV 计算中级标准偏差，也就是偏离组中平均值的程度。通过查找方差的平方根来得到这种偏差。`STDDEV(DISTINCT expr)` 返回组中唯一非空数据的标准偏差。`STDDEV(ALL expr)` 和 `STDDEV(expr)` 返回组中非空数据的标准偏差。expr 参数的数据类型是 NUMBER。

## 确定可用的分组函数

### 使用分组函数

1. COUNT 函数