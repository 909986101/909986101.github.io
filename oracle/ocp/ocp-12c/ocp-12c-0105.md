# 使用转换函数和条件表达式

## SQL 中可用的各种类型的转换函数介绍

SQL 转换函数是单行函数，它们可用来改变列值、表达式或者字面值数据类型的本质。最广泛使用的转换函数是 TO_CHAR、TO_NUMBER 和 TO_DATE 这三个函数。

### 转换函数

NUMBER 类型不能存储字符信息。DATE 不能存储随机字符或者随机数。然而，VARCHAR2 可以存储数字和日期信息的字符形式。

如果接受字符输入参数的函数使用数字，Oracle 就会自动将它转换为字符形式。如果接受数字或者日期参数的函数使用字符值，就有一些特殊条件，在这些条件下才会发生自动数据类型转换。相对于 VARCHAR2 和 CHAR 而言，DATE 和 NUMBER 数据类型更加严格。

虽然可以使用隐式数据类型转换，但更可靠的方法是使用单行转换函数将这些值从一种数据类型显式转换为另一种数据类型。将字符信息转换为 NUMBER 和 DATE 数据类型取决于格式掩码。

要小心使用隐式转换。在有些情况下，它不会像预期的那样运行。

1. 隐式数据类型转换
   
   如果可能，可以将数据类型与函数所需参数的数据类型不相符的值隐式转换为所需的格式。VARCHAR2 和 CHAR 数据类型统称为字符类型。字符字段非常灵活，几乎允许存储所有类型的信息。因此，可以方便的将 DATE 和 NUMBER 值转换为它们的字符形式。这些转换称为数字到字符（number to character）和日期到字符（date to character）转换。

   将字符数据隐式转换为数字数据类型的情况并不常见，因为出现这种情况的唯一条件是该字符数据表示有效数字。字符串“11”会被隐式转换位数字，但“11.123.456”不会。

   当字符串符合下面的日期模式时，可以实现字符到日期（character to date）的隐式转换

   `[D|DD]separator1[MON|MONTH]separator2[R|RR|YYYY]`

   D 和 DD 分别表示月份中 1 位和 2 位数字的日子。MON 是月的三字符缩写词，而 MONTH 是月的全名。R 和 RR 分别表示 1 位和 2 位数字的年。YYYY 表示 4 位数字的年。separator1 和 separator2 元素可以是大多数标点符号、空格和制表符。separator1 和 separator2 可以不同。

1. 显式数据类型转换
   
   Oracle 提供的许多函数可以将值从一种数据类型转换为另一种数据类型，这些函数称为显式数据类型转换函数。这些函数返回的值保证是所需的类型，它们为转换数据项提供了一种安全可靠的方法。

   Oracle 的格式掩码能够广泛控制字符到数字和字符到日期的转换。

## 使用 TO_CHAR、TO_NUMBER 和 TO_DATE 转换函数

### 使用转换函数

表5-2 显式数据类型转换函数的语法

|字符转数值和日期|数值和日期转字符|
|:-|:-|
|`TO_NUMBER(char1, [fromat mask], [nls_parameters]) = num1`|`TO_CHAR(char1, [fromat mask], [nls_parameters]) = char1`|
|`TO_DATE(char1, [fromat mask], [nls_parameters]) = date1`|`TO_CHAR(char1, [fromat mask], [nls_parameters]) = char1`|

可选国家语言支持参数 `NLS_PARAMETERS` 对于指定返回日期和数字元素的语言和格式非常有用。因此会使用日期和数字元素的默认值。有一种公共可用的视图 `NLS_SESSION_PARAMETERS`，它包含当前会话的 `NLS` 参数。

`NLS_CURRENCY` 的默认值是美元符号（$）,但在用户会话级别可以改变该值。

1. 使用 TO_CHAR 函数将数字转换为字符
   
   TO_CHAR 函数返回 VARCHAR2 数据类型的值。当将它应用于 NUMBER 数据类型的值时，可以使用几种格式选项。

   `TO_CHAR(number1, [format], [nls_parameter])`

   number1 参数是强制性的，它必须是一个值，这个值能够被隐式转换为数字。可选的 format 参数用来指定数字格式信息，例如：宽度、货币符号、小数点的位置和组（或者千位）分隔符，必须将它们包含在单引号内。

   表5-3 数字格式掩码

   |格式元素|元素说明|格式|数字|字符结果|备注
   |:-|:-|-:|-:|-:|-:|
   |`9`|数字宽度|9999|12|12|
   |`0`|显式前面的 0|09999|0012|00012|
   |`.`|小数点位置|09999.999|030.40|00030.400|
   |`D`|小数分隔符的位置（默认为句点）|09999D999|030.40|00030.400|
   |`,`|逗号的位置|09999,999|03040|00003,040|
   |`G`|组分隔符的位置（默认为逗号）|09999G999|03040|00003.040|
   |`$`|美元符号|\$099999|03040|\$003040|
   |`L`|当地货币|L099999|03040|￥003040|如果 NLS_CURRENCY 设置为￥
   |`MI`|表示负数的减号的位置|99999MI|-3040|3040-|
   |`PR`|以括号的形式将负数括起来|99999PR|-3040|<3040>|
   |`EEEE`|科学计数法|99.99999EEEE|121.976|1.21976E+02|
   |`U`|NLS_DUAL_CURRENCY|U099999|03040|CAD003040|如果 NLS_DUAL_CURRENCY 设置为 CAD|
   |`V`|乘以 10<sup>n</sup>|9999V99|3040|304000|
   |`S`|前面加上+或者-|S999999|3040|+3040|

1. 使用 TO_CHAR 函数将日期转换为字符
   
   使用 TO_CHAR 函数，可以利用各种格式模型将 DATE 项转换为几乎所有日期的字符表示形式。

   `TO_CHAR(date1, [format], [nls_parameter])`

   只有 date1 参数是强制的，date1 必须是可以被隐式转换为日期的值。可选的 format 参数区分大小写，必须将它包含在单引号内。格式掩码指定提取哪些日期元素。格式掩码会自动给日和月的名称添加空格。可以使用格式掩码的修饰符来删除这些空格，这个修饰符称为填充模式（fm）运算符。在格式模式之前添加字母“fm”。
   
   ```
   SQL> SELECT TO_CHAR('03-JAN-09', 'Month')||'is a special time' FROM DUAL;
   January is a special time

   SQL> SELECT TO_CHAR('03-SEP-09', 'Month')||'is a special time' FROM DUAL;
   Septemberis a spectial time

   SQL> SELECT TO_CHAR('03-JAN-09', 'fmMonth')||'is a special time' FROM DUAL;
   Januaryis a spectial time
   ```

   在表 5-4 中，假设格式元素作用于日期 `18-APR-1974`。

   表5-4 日、月和年的日期格式掩码

   |格式元素|说明|结果|
   |:-|:-|:-|
   |Y|年的最后一位|4|
   |YY|年的最后两位|74|
   |YYY|年的最后三位|974|
   |YYYY|四位数字表示的年|1974|
   |RR|两位数字表示的年|74|
   |YEAR|区分大小写并用英语拼写的年|NINETEEN SEVENTY-FOUR|
   |MM|两位数表示的月|04|
   |MON|月的三个字母缩写|APR|
   |MONTH|区分大小写并用英语拼写的月|APRIL|
   |D|星期几|4|
   |DD|月的两位数日|18|
   |DDD|年的日||
   |DY|星期的三个字母缩写|THU|
   |DAY|区分大小写并用英语拼写的星期|THURSDAY|

   表 5-5 中列出了关于周、季度、世纪和其他不常用格式掩码的日期格式。该表使用日期 `24-SEP-1000 BD` 以及格式元素列的格式掩码来计算 TO_CHAR 函数，从而得到结果列。

   表5-5 不常用的日期格式掩码

   |格式元素|说明|结果|
   |:-|:-|:-|
   |W|月的周数|4|
   |WW|年的周数|39|
   |Q|年的季度|3|
   |CC|世纪|10|
   |S preceding CC、YYYY 或者 YEAR|如果日期是 BC，那么减号就在结果之前|-10、-1000 或者 -ONE THOUSAND|
   |IYYY、IYY、IY、I|分别表示四、三、二、一位 ISO 日期|1000、000、00、0|
   |BC、AD、B.C. 和 A.D.|BC、AD、有句点间隔的 B.C. 或者 A.D.|BC|
   |J|儒略日，从公元前 4713 年 12 月 31 日开始的天数|1356075|
   |IW|ISO 标准周（1 到 53）|39|
   |RM|用罗马数字表示的月|IX|

   使用表 5-6 中的格式模型提取日期时间数据类型的时间组件。该表使用包括其时间组件的日期 `27-JUN-2010 21.:35:13`。

   表5-6 时间组件的日期格式掩码

   |格式元素|说明|结果|
   |:-|:-|:-|
   |AM、PM、A.M. 和 P.M.|子午线指示器|PM|
   |HH、HH12 和 HH24|一天的小时、1~12 时和 0~23 时|09、09、21|
   |MI|分（0~59）|35|
   |SS|秒（0~59）|13|
   |SSSSS|子午之后的秒（0~86399）|77715|

   表 5-7 中列出了其他一些能够在日期时间格式模型中使用的元素。使用日期 `12/SEP/08 14:31`。

   |格式元素|说明和格式掩码|结果|
   |:-|:-|:-|
   |`-/.,?#!`|标点符号，`'MM.YY'`|09.08|
   |`"any character literal"`|字符字面值，`'"Week" W "of" Month'`|Week 2 of Septermber|
   |`TH`|位置或者序数文本，`'DDth "of" Month'`|12<sup>TH</sup> of Septermber|
   |`SP`|拼写出数字，`'MmSp Month Yyyysp'`|Nine September Two Thousand Eight|
   |`THSP 或 SPTH`|拼写出位置或者序数，`hh24SpTh`|Fourteenth|

1. 使用 TO_DATE 函数将字符转换为日期