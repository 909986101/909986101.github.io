# 使用集合运算符

所有 SELECT 语句都返回一组行。集合运算符将两个或者更多个 SELECT 语句的结果作为输入，并从中生成一个结果集。这就是所谓的复合查询（compound query）。Oracle 提供了三种集合运算符，UNION、INTERSECT 和 MINUS。UNION 可以使用 ALL 限定。与 SQL 的 ISO 标准显著背离的是，Oracle 使用 MINUS 来实现 ISO SQL 使用 EXCEPT 实现的功能。

## 描述集合运算符

复合查询中使用的集合运算符包括
- UNION：返回两个查询的合并行，排序这些行并删除重复行。
- UNION ALL：返回连个查询的合并行，不对这些行排序，也不删除重复行。
- INTERSECT：只返回同时出现在两个查询的结果集中的行，排序这些行并删除重复行。
- MINUS：只返回第一个结果集中的行，且这些行没有出现在第二个结果集中，排序这些行并删除重复行。

### 集合和维恩图

### 集合运算符的一般原则

所有集合运算符都通过合并两个或者更多查询的结果集来生成复合查询。如果 SELECT 语句包含多个集合运算符（即多于两个查询），就会按编程人员指定的顺序应用它们：从上到下，从左到右。虽然对 ISO SQL 的未决强化（pending enhancement）会给 INTERSECT 提供比其他运算符更高的优先级，但当前运算符没有优先级。要重写这种优先级，依据运算符出现的顺序执行，那么可以使用圆括号：先计算括号内的运算符，之后将结果传递给括号外面的运算符。

复合查询中的每个查询都投影自己选中列的列表。这些列表的元素数量必须相同，排列顺序必须相同，数据类型也必须大致相同。它们的名称（或列别名）不一定相同，也不一定来自相同的表（或者子查询）。如果列名（或别名）不同，那么复合查询的结果集就将列命名为第一个查询中列的名称。

虽然选中列的列表不一定有完全相同的数据类型，但它们必须来自相同的数据类型组。复合查询的结果集的列通常取更高的精度。除了接受来自相同组的数据类型之外，集合运算符不会进行任何隐式类型转换。

UNION、MINUS 和 INTERSECT 总是合并输入查询的结果集，然后排序结果，删除重复行。依据所有列，从左到右排序。如果两行中所有列的值都相同，那么在复合结果集中只返回第一行。也就是说，复合查询的输出一定要排序。如果排列顺序（升序，基于列在选择列表中出现的顺序）不是想要的顺序。那么可以在复合查询的结尾添加一个 ORDER BY 子句。不可以在组成整个复合查询的所有查询中使用 ORDER BY，因为这样会中断删除重复行所需的排序。

UNION ALL 是排序无重复行（sorting-no-duplicates）规则的例外：两个输入查询的结果集会串联起来，形成复合查询的结果。但不能在单个查询中使用 ORDER BY 子句，ORDER BY 子句只能出现在复合查询的结尾，在那里应用它来排序结果集。

## 使用集合运算符将多个查询合并为一个查询

### UNION ALL 运算符

UNION ALL 使用两个结果集，并将它们合并为一个结果集。来自两个查询的结果集必须选择相同的列数，这两个查询对应的列（以它们被指定的顺序）必须来自相同的数据类型组。这些列的名称不一定相同。

### UNION 运算符

UNION 实现 UNION ALL，然后依据所有列来排列结果，并删除重复的行。

因为排序的原因，UNION 复合查询中查询的顺序与返回的行的顺序没有什么区别。

注意

如果知道两个表之间可能没有重复行，那么就可以使用 UNION ALL，这样可以让数据库不再进行排序。如果在不必要的时候使用 UNION，DBA 会不高兴的。

### INTERSECT 运算符

两个集合的交集是两个集合的公共行。

### MINUS 运算符

MINUS 运行两个查询，排列结果的顺序，只返回第一个结果集中的行，但这些行不在第二个结果集中。

### 更复杂的示例
  
如果两个查询不返回相同的列表，通过生成包含 NULL 值的其他列，依然可以在复合查询中运行它们。

复合查询可以由两个以上的查询组成，在这种情况下，可以使用括号来控制运算符的优先级。在没有括号的情况下，以它们被指定的顺序应用集合运算符。

## 控制返回行的顺序

在默认情况下，UNION ALL 复合查询的输出根本不排序：会按组返回行，先按列出查询的顺序排列，在分组内按它们被保存的顺序排列。其他集合运算符的输出按所有列的升序排列，从命名的第一列开始。

从语法上讲，不可能在组成复合查询的单个查询中使用 ORDER BY 子句。这是因为，大多数复合查询的执行必须对行进行排序，这可能与 ORDER BY 子句产生冲突。从理论上讲，UNION ALL（不对行进行排序）似乎可以在每个查询中使用 ORDER BY 子句，但是 UNION ALL 的 Oracle 实现方式不允许这样做。

然而，在复合查询的结尾添加一个 ORDER BY 子句是没有问题的。这会排序复合查询的整个输出。行的默认排序基于所有列。按照它们出现的顺序排列。指定的 ORDER BY 子句没有限制：它可以基于任何列（以及应用于列的函数）按任何顺序排序。

注意，ORDER BY 子句中的列名必须是复合查询的第一个查询中列的名称（或者别名）。